<html><head><title>Project Status</title></head>
<body>
<center><h3>Dynamically Recompiling ARM Emulator</h3>
<h4>Status Report</h4>
<h5>Julian T. Brown, Queens' College (jtb20@cam.ac.uk)</h5>
<h5><i>Supervisor: Dr. Martin Richards, DoS: Dr. Robin Walker</i></h5></center>

<p>The purpose of my project is to emulate an ARM processor (instruction set) quickly on a foreign platform, Linux/x86. This is done using a mixture of emulation, and compilation of frequently-executed code to native machine language.

<p>The first phase of the project, decoding and accurately interpreting ARM instructions, is more or less complete. The idea mentioned in the project proposal of using 'fake' system calls to avoid running a complete operating system with all the complexities that involves has also been done to some extent - the ARM BBC BASIC module extracted from Acorn's RISC OS operating system is able to run under (plain) emulation. However, several details are missing - it's not possible to change processor mode, and there is no memory-management support. Compile-time switches theoretically allow changing between 26-bit (needed for BASIC) and 32-bit addressing modes.

<p>Profiling to discover frequently-executed chunks of ARM code works well. In a slight deviation to the original plan, these chunks of code are converted into a highly orthogonal intermediate representation (quad-register code augmented with side-effect information) and analysed before translation into native Intel code, rather than doing the conversion directly on an instruction-by-instruction basis. The analysis stage includes splitting the chunk of ARM code into basic blocks, calculating data-flow graphs within those blocks and calculating a control-flow graph between them.

<p>Translation into native code works using a greedy template matching algorithm, which uses the intermediate code representation together with the data flow information gathered previously. Instructions matching a template need not be adjacent. Each of the approximately 130 templates has an associated code generator function which emits a fragment of equivalent Intel code given a successful match. Each template and each generator function may be arbitrarily complex, in the cases where many intermediate code instructions can map onto few Intel instructions and vice versa, respectively. I believe the algorithm currently has minor imperfections with respect to side-effects (status flags affected), but they may only show in pathological circumstances and are probably easy to fix anyway.

<p>Another idea mentioned in the project proposal, lazy flag cacheing, has been implemented though not yet exhaustively tested. Although Intel instructions generally set flags in altogether different ways to the ARM, there are circumstances (eg, CMP - compare instructions) where the two processors do roughly the same thing. Rather than calculate flags explicitly, the processor's native logic is used, and the results are kept in its flag register as long as possible, only being stored to a memory-based dump at the last moment before they're clobbered. Complications arise due to the Intel chip using the carry flag in the opposite sense to the ARM in subtraction operations - the mechanism which deals with this isn't very clean, but does try to avoid generating unnecessary inversion instructions wherever possible.

<p>Other obvious problems, like what to do about calculated branches in recompiled code (setting the program counter as the result of arbitrary calculations) have been mostly resolved. The recompiler is currently in a heavy debugging phase - the code it generates generally looks fairly plausible on inspection, but doesn't yet necessarily do the right thing when executed.

<p>According to the original work plan, despite necessary differences to it due to the slightly experimental nature of the project, I am roughly on schedule. However, because the project is fairly open-ended, I feel I need to establish a point beyond which programming will have ceased - the end of this term seems reasonable, leaving the Easter vacation in which to write the dissertation.

</body></html>
